{% load static%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class and Student Details</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    {% include 'school-admin/admin_dashboard/partials/admin_navber.html' %}
<div class="container mt-4">
    <input type="text" id="searchInput" placeholder="Search by Class Name" class="p-2 mx-auto mb-4 form-control">
    <div class="row" id="classCards">
        <!-- Bootstrap Cards will be inserted here -->
    </div>
</div>
  
<script type="text/javascript">
    // Flatten the 2D list into a single list
    const students = {{ student_json|safe }}.flat();

    // Group students by class_name
    const groupStudentsByClass = (students) => {
        return students.reduce((result, student) => {
            (result[student.class_name] = result[student.class_name] || []).push(student);
            return result;
        }, {});
    };

    // Group the students by their class
    let classes = groupStudentsByClass(students);

    // Function to generate PDF
    const generatePDF = (className, studentList) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(20);
        doc.text('Excomsgi Students Report Sheet', 55, 10);

        const logoImg =  '{% static "student-static/images/schoollogo.png" %}'; 
        const logoWidth = 30;
        const logoHeight = 30;

        doc.addImage(logoImg, 'PNG', 5, 1, logoWidth, logoHeight);

        doc.setFontSize(16);
        doc.text(`Class: ${className}`, 15, 35);
        doc.text(`Number of students: ${studentList.length}`, 15, 45);

        const tableRows = studentList.map((student, index) => [
            index + 1,
            student.name,
            student.surname,
            student.admission_no,
            student.total_score,
            student.position
        ]);

        doc.autoTable({
            head: [['No', 'First Name', 'Surname', 'Reg Number', 'Total Score', 'Position']],
            body: tableRows,
            startY: 60
        });

        doc.save(`${className}_students.pdf`);
    };

    // Function to display Bootstrap cards
    const displayCards = (classes) => {
        const classCardsContainer = document.getElementById('classCards');
        classCardsContainer.innerHTML = ''; // Clear existing cards

        Object.keys(classes).forEach(className => {
            const studentList = classes[className];

            const card = document.createElement('div');
            card.classList.add('col-md-4');
            card.innerHTML = `
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Class: ${className}</h5>
                        <p class="card-text">Number of Students: ${studentList.length}</p>
                        <button class="btn btn-primary download-btn">
                            Download PDF
                        </button>
                    </div>
                </div>
            `;

            classCardsContainer.appendChild(card);

            card.querySelector('.download-btn').addEventListener('click', () => {
                generatePDF(className, studentList);
            });
        });
    };

    // Initial display of class cards
    displayCards(classes);

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function () {
        const query = this.value.toLowerCase();
        const filteredClasses = Object.fromEntries(
            Object.entries(classes).filter(([className, students]) =>
                className.toLowerCase().includes(query)
            )
        );
        displayCards(filteredClasses);
    });
</script>
 
</body>
</html>